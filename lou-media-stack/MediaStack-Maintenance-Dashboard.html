<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaStack Live Maintenance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
        }

        .header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #4a90e2;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            min-width: 120px;
        }

        .status-count {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .running { color: #4CAF50; }
        .restarting { color: #FF9800; }
        .exited { color: #f44336; }
        .unhealthy { color: #E91E63; }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .restart-all-btn {
            background: linear-gradient(45deg, #FF9800, #e68900);
            color: white;
        }

        .logs-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .service-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--status-color, #666);
            transition: all 0.3s ease;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .service-name {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .service-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .detail-label {
            opacity: 0.8;
        }

        .detail-value {
            font-weight: bold;
        }

        .service-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 80px;
        }

        .restart-btn {
            background: linear-gradient(45deg, #FF9800, #e68900);
            color: white;
        }

        .logs-btn-small {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .config-btn {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .web-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .last-updated {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            color: #ffcdd2;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #4CAF50;
        }

        .notification.error {
            background: #f44336;
        }

        .notification.info {
            background: #2196F3;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: white;
        }

        .log-content {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .services-grid {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 200px;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ MediaStack Live Dashboard</h1>
        <p class="subtitle">Real-time monitoring and maintenance for all services</p>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="status-count running" id="running-count">-</div>
            <div class="status-label">Running</div>
        </div>
        <div class="status-item">
            <div class="status-count restarting" id="restarting-count">-</div>
            <div class="status-label">Restarting</div>
        </div>
        <div class="status-item">
            <div class="status-count exited" id="exited-count">-</div>
            <div class="status-label">Stopped/Exited</div>
        </div>
        <div class="status-item">
            <div class="status-count unhealthy" id="unhealthy-count">-</div>
            <div class="status-label">Unhealthy</div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn refresh-btn" onclick="refreshAll()">üîÑ Refresh All</button>
        <button class="control-btn restart-all-btn" onclick="confirmRestartAll()">üîÑ Restart Problem Services</button>
        <button class="control-btn logs-btn" onclick="showSystemLogs()">üìã System Logs</button>
    </div>

    <div id="services-container">
        <div class="loading">
            <div class="spinner"></div>
            Loading services...
        </div>
    </div>

    <div class="last-updated" id="last-updated">
        Last updated: Never
    </div>

    <!-- Log Modal -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Service Logs</h2>
            <div class="log-content" id="log-content">Loading logs...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let services = {};
        let autoRefresh = true;
        let refreshInterval;

        // Service configuration mapping
        const serviceConfig = {
            'plex': { port: 32400, hasWeb: true, webPath: ':32400/web' },
            'sonarr': { port: 8989, hasWeb: true, webPath: ':8989' },
            'radarr': { port: 7878, hasWeb: true, webPath: ':7878' },
            'bazarr': { port: 6767, hasWeb: true, webPath: ':6767' },
            'prowlarr': { port: 9696, hasWeb: true, webPath: ':9696' },
            'overseerr': { port: 5055, hasWeb: true, webPath: ':5055' },
            'tautulli': { port: 8181, hasWeb: true, webPath: ':8181' },
            'qbittorrent': { port: 8080, hasWeb: true, webPath: ':8080' },
            'portainer': { port: 9000, hasWeb: true, webPath: ':9000' },
            'homepage': { port: 3000, hasWeb: true, webPath: ':3000' },
            'watchtower': { hasWeb: false },
            'filebot': { hasWeb: false, hasConfig: true, configPath: '/config/filebot' },
            'wireguard': { hasConfig: true, configPath: '/config/wireguard' },
            'ddns-updater': { hasConfig: true, configPath: '/config/ddns-updater' },
            'headscale': { hasConfig: true, configPath: '/config/headscale' },
            'headplane': { hasConfig: true, configPath: '/config/headplane' },
            'ai-recommendation-engine': { hasConfig: true, configPath: '/config/ai-recommendation' }
        };

        async function fetchServices() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                services = data.containers;
                updateUI();
                updateLastUpdated();
                
            } catch (error) {
                console.error('Error fetching services:', error);
                showError(`Failed to connect to monitoring API: ${error.message}`);
            }
        }

        function updateUI() {
            updateStatusCounts();
            renderServices();
        }

        function updateStatusCounts() {
            const counts = {
                running: 0,
                restarting: 0,
                exited: 0,
                unhealthy: 0
            };

            Object.values(services).forEach(service => {
                const status = service.status.toLowerCase();
                if (status.includes('running')) {
                    if (service.health === 'unhealthy') counts.unhealthy++;
                    else counts.running++;
                } else if (status.includes('restarting')) {
                    counts.restarting++;
                } else if (status.includes('exited') || status.includes('stopped')) {
                    counts.exited++;
                }
            });

            document.getElementById('running-count').textContent = counts.running;
            document.getElementById('restarting-count').textContent = counts.restarting;
            document.getElementById('exited-count').textContent = counts.exited;
            document.getElementById('unhealthy-count').textContent = counts.unhealthy;
        }

        function renderServices() {
            const container = document.getElementById('services-container');
            
            if (Object.keys(services).length === 0) {
                container.innerHTML = '<div class="error-message">No services found or API unavailable</div>';
                return;
            }

            container.innerHTML = `
                <div class="services-grid">
                    ${Object.entries(services).map(([name, service]) => createServiceCard(name, service)).join('')}
                </div>
            `;
        }

        function createServiceCard(name, service) {
            const config = serviceConfig[name] || {};
            const status = service.status.toLowerCase();
            const isRunning = status.includes('running');
            const isRestarting = status.includes('restarting');
            const isExited = status.includes('exited') || status.includes('stopped');
            const isUnhealthy = service.health === 'unhealthy';

            let statusColor, statusBg, statusText;
            
            if (isUnhealthy) {
                statusColor = '#E91E63';
                statusBg = 'rgba(233, 30, 99, 0.2)';
                statusText = 'Unhealthy';
            } else if (isRunning) {
                statusColor = '#4CAF50';
                statusBg = 'rgba(76, 175, 80, 0.2)';
                statusText = 'Running';
            } else if (isRestarting) {
                statusColor = '#FF9800';
                statusBg = 'rgba(255, 152, 0, 0.2)';
                statusText = 'Restarting';
            } else if (isExited) {
                statusColor = '#f44336';
                statusBg = 'rgba(244, 67, 54, 0.2)';
                statusText = 'Stopped';
            } else {
                statusColor = '#666';
                statusBg = 'rgba(102, 102, 102, 0.2)';
                statusText = service.status;
            }

            const uptime = formatUptime(service.created_at);
            const ports = service.ports && service.ports.length > 0 ? service.ports.join(', ') : 'None';

            return `
                <div class="service-card" style="--status-color: ${statusColor}">
                    <div class="service-header">
                        <div class="service-name">${name.charAt(0).toUpperCase() + name.slice(1)}</div>
                        <div class="status-badge" style="background: ${statusBg}; color: ${statusColor}">
                            ${statusText}
                        </div>
                    </div>
                    
                    <div class="service-details">
                        <div class="detail-row">
                            <span class="detail-label">Container:</span>
                            <span class="detail-value">${service.name}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Image:</span>
                            <span class="detail-value">${service.image}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Ports:</span>
                            <span class="detail-value">${ports}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Created:</span>
                            <span class="detail-value">${uptime}</span>
                        </div>
                        ${service.health ? `
                        <div class="detail-row">
                            <span class="detail-label">Health:</span>
                            <span class="detail-value">${service.health}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="service-actions">
                        <button class="action-btn restart-btn" onclick="restartService('${name}')">
                            üîÑ Restart
                        </button>
                        <button class="action-btn logs-btn-small" onclick="showLogs('${name}')">
                            üìã Logs
                        </button>
                        ${config.hasWeb ? `
                            <button class="action-btn web-btn" onclick="openWebUI('${name}', '${config.webPath}')">
                                üåê Web UI
                            </button>
                        ` : ''}
                        ${config.hasConfig ? `
                            <button class="action-btn config-btn" onclick="showConfig('${name}')">
                                ‚öôÔ∏è Config
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function formatUptime(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const diff = now - created;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) return `${days}d ${hours}h ago`;
            if (hours > 0) return `${hours}h ${minutes}m ago`;
            return `${minutes}m ago`;
        }

        async function restartService(serviceName) {
            try {
                showNotification('info', `Restarting ${serviceName}...`);
                const response = await fetch(`${API_BASE}/restart/${serviceName}`, { method: 'POST' });
                
                if (response.ok) {
                    showNotification('success', `${serviceName} restarted successfully!`);
                    setTimeout(() => fetchServices(), 2000); // Refresh after 2 seconds
                } else {
                    const error = await response.text();
                    throw new Error(error);
                }
            } catch (error) {
                showNotification('error', `Failed to restart ${serviceName}: ${error.message}`);
            }
        }

        async function showLogs(serviceName) {
            document.getElementById('modal-title').textContent = `${serviceName} Logs`;
            document.getElementById('log-content').textContent = 'Loading logs...';
            document.getElementById('logModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/logs/${serviceName}?lines=100`);
                const logs = await response.text();
                document.getElementById('log-content').textContent = logs || 'No logs available';
            } catch (error) {
                document.getElementById('log-content').textContent = `Error loading logs: ${error.message}`;
            }
        }

        async function showSystemLogs() {
            document.getElementById('modal-title').textContent = 'System Summary';
            document.getElementById('log-content').textContent = 'Loading system information...';
            document.getElementById('logModal').style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/summary`);
                const summary = await response.json();
                
                let content = '=== SYSTEM SUMMARY ===\n\n';
                content += `Total Containers: ${summary.total_containers}\n`;
                content += `Running: ${summary.running}\n`;
                content += `Stopped: ${summary.stopped}\n`;
                content += `Restarting: ${summary.restarting}\n`;
                content += `Unhealthy: ${summary.unhealthy}\n\n`;
                
                content += '=== PROBLEM SERVICES ===\n';
                Object.entries(services).forEach(([name, service]) => {
                    const status = service.status.toLowerCase();
                    if (!status.includes('running') || service.health === 'unhealthy') {
                        content += `${name}: ${service.status}`;
                        if (service.health) content += ` (${service.health})`;
                        content += '\n';
                    }
                });
                
                document.getElementById('log-content').textContent = content;
            } catch (error) {
                document.getElementById('log-content').textContent = `Error loading system info: ${error.message}`;
            }
        }

        function openWebUI(serviceName, webPath) {
            const url = `http://localhost${webPath}`;
            window.open(url, '_blank');
        }

        function showConfig(serviceName) {
            const config = serviceConfig[serviceName];
            if (config && config.configPath) {
                showNotification('info', `Config location: ${config.configPath}`);
            } else {
                showNotification('info', `No config path defined for ${serviceName}`);
            }
        }

        function closeModal() {
            document.getElementById('logModal').style.display = 'none';
        }

        function confirmRestartAll() {
            if (confirm('Restart all problematic services? This will restart any containers that are not running properly.')) {
                restartProblemServices();
            }
        }

        async function restartProblemServices() {
            const problemServices = Object.entries(services).filter(([name, service]) => {
                const status = service.status.toLowerCase();
                return !status.includes('running') || service.health === 'unhealthy';
            });

            if (problemServices.length === 0) {
                showNotification('info', 'No problematic services found!');
                return;
            }

            showNotification('info', `Restarting ${problemServices.length} problematic services...`);
            
            for (const [name, service] of problemServices) {
                try {
                    await restartService(name);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second between restarts
                } catch (error) {
                    console.error(`Failed to restart ${name}:`, error);
                }
            }
            
            setTimeout(() => fetchServices(), 5000); // Refresh after 5 seconds
        }

        function refreshAll() {
            showNotification('info', 'Refreshing all services...');
            fetchServices();
        }

        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('last-updated').textContent = 
                `Last updated: ${now.toLocaleTimeString()}`;
        }

        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        function showError(message) {
            const container = document.getElementById('services-container');
            container.innerHTML = `<div class="error-message">${message}<br><br>Make sure the monitoring API is running:<br><code>cd /home/lou/lou-media-stack/monitoring && python status_api.py</code></div>`;
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (autoRefresh) {
                    fetchServices();
                }
            }, 10000); // Refresh every 10 seconds
        }

        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;
            if (autoRefresh) {
                startAutoRefresh();
                showNotification('info', 'Auto-refresh enabled');
            } else {
                clearInterval(refreshInterval);
                showNotification('info', 'Auto-refresh disabled');
            }
        }

        // Handle modal clicks
        window.onclick = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'r' && event.ctrlKey) {
                event.preventDefault();
                refreshAll();
            } else if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            fetchServices();
            startAutoRefresh();
            
            // Add auto-refresh toggle to header
            const subtitle = document.querySelector('.subtitle');
            subtitle.innerHTML += ' | Press Ctrl+R to refresh | <span style="cursor: pointer; text-decoration: underline;" onclick="toggleAutoRefresh()">Toggle Auto-refresh</span>';
        });

        // Handle page visibility changes (pause refresh when tab is not visible)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                autoRefresh = false;
            } else {
                autoRefresh = true;
                fetchServices(); // Immediate refresh when tab becomes visible
            }
        });
    </script>
</body>
</html>
