version: '3.8'

services:
  unified-dashboard:
    image: nginx:alpine
    container_name: mediastack-unified-dashboard
    restart: unless-stopped
    volumes:
      - ./:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - mediastack
    ports:
      - "8600:80"  # Phase 7: Unified Dashboard
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`dashboard.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.services.dashboard.loadbalancer.server.port=80"
    environment:
      - TZ=${TZ:-UTC}
    depends_on:
      - api-proxy

  # API Proxy to handle CORS and authentication
  api-proxy:
    image: node:18-alpine
    container_name: mediastack-api-proxy
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./api-proxy:/app
    networks:
      - mediastack
    ports:
      - "8601:3000"  # API Proxy port
    environment:
      - NODE_ENV=production
      - TZ=${TZ:-UTC}
      # Your media stack service URLs
      - SONARR_URL=http://mediastack-sonarr:8989
      - RADARR_URL=http://mediastack-radarr:7878
      - LIDARR_URL=http://mediastack-lidarr:8686
      - JACKETT_URL=http://mediastack-jackett:9117
      - TVHEADEND_URL=http://mediastack-tvheadend:9981
      - XTEVE_URL=http://mediastack-xteve:34400
      - JELLYFIN_URL=http://mediastack-jellyfin:8096
      - PLEX_URL=http://mediastack-plex:32400
      # API Keys (set in your .env file)
      - SONARR_API_KEY=${SONARR_API_KEY}
      - RADARR_API_KEY=${RADARR_API_KEY}
      - LIDARR_API_KEY=${LIDARR_API_KEY}
      - JACKETT_API_KEY=${JACKETT_API_KEY}
    command: npm start

networks:
  mediastack:
    external: true
