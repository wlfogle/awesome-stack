app-id: org.originpc.ControlCenter # OriginPC Control Center
runtime: org.kde.Platform
runtime-version: '5.15-23.08'
sdk: org.kde.Sdk
command: originpc-control-center
finish-args:
  # X11 + Wayland access
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  # Hardware access for RGB control
  - --device=all
  # System monitoring capabilities
  - --system-talk-name=org.freedesktop.login1
  - --system-talk-name=org.freedesktop.UPower
  - --system-talk-name=org.freedesktop.thermald
  # Allow notification
  - --talk-name=org.freedesktop.Notifications
  # Allow dbus communication with system services
  - --system-talk-name=org.freedesktop.NetworkManager
  - --talk-name=org.kde.StatusNotifierWatcher
  # Filesystem access for configuration
  - --filesystem=xdg-config/enhanced-originpc-control:create
  - --filesystem=home/.config/enhanced-originpc-control:create
  # Access for system monitoring tools
  - --filesystem=/proc/acpi:ro
  - --filesystem=/sys/class/power_supply:ro
  - --filesystem=/sys/class/hwmon:ro
  - --filesystem=/sys/devices:ro
  # Allow persistent background operation
  - --persist=.config/enhanced-originpc-control

modules:
  # Core Python dependencies
  - name: python-base-deps
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} flit_core setuptools wheel
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/f/flit_core/flit_core-3.9.0.tar.gz
        sha256: 72ad266176c4a3fcfab5f2930d76896059851240570ce9a98733b658cb786eba
      - type: file
        url: https://files.pythonhosted.org/packages/source/s/setuptools/setuptools-69.2.0.tar.gz
        sha256: 0ff4183f8f42cd8fa3acea16c45205521a4ef28f73c6391d8a25e92893134f2e
      - type: file
        url: https://files.pythonhosted.org/packages/source/w/wheel/wheel-0.43.0.tar.gz
        sha256: 465ef92c69fa5c5da2d1cf8ac40559a8c940886afcef87dcf14b9470862f1d85

  # Cython (needed for psutil and numpy)
  - name: cython
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} Cython
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/C/Cython/Cython-0.29.34.tar.gz
        sha256: 1909688f5d7b521a60c396d20bba9e47a1b2d2784bfb085401e1e1e7d29a29a8

  # psutil (system monitoring)
  - name: psutil
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} flit_core
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} wheel
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} setuptools
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} psutil
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/p/psutil/psutil-5.9.8.tar.gz
        sha256: 6be126e3225486dff286a8fb9a06246a5253f4c7c53b475ea5f5ac934e64194c
      - type: file
        url: https://files.pythonhosted.org/packages/source/s/setuptools/setuptools-69.2.0.tar.gz
        sha256: 0ff4183f8f42cd8fa3acea16c45205521a4ef28f73c6391d8a25e92893134f2e
      - type: file
        url: https://files.pythonhosted.org/packages/source/w/wheel/wheel-0.43.0.tar.gz
        sha256: 465ef92c69fa5c5da2d1cf8ac40559a8c940886afcef87dcf14b9470862f1d85
      - type: file
        url: https://files.pythonhosted.org/packages/source/f/flit_core/flit_core-3.9.0.tar.gz
        sha256: 72ad266176c4a3fcfab5f2930d76896059851240570ce9a98733b658cb786eba

  # Numpy module removed due to build issues with meson-python
  # Will use system numpy if available

  # GPUtil for GPU monitoring
  - name: gputil
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} GPUtil
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/source/G/GPUtil/GPUtil-1.4.0.tar.gz
        sha256: 099e52c65e512cdfa8c8763fca67f5a5c2afb63469602d5dcb4d296b3661efb9

  - name: originpc-control-center
    buildsystem: simple
    build-commands:
      # Create directories
      - mkdir -p ${FLATPAK_DEST}/bin
      - mkdir -p ${FLATPAK_DEST}/share/applications
      - mkdir -p ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps
      - mkdir -p ${FLATPAK_DEST}/lib/python3/site-packages/originpc_rgb
      
      # Install main application
      - install -Dm755 enhanced-professional-control-center.py ${FLATPAK_DEST}/bin/originpc-control-center
      
      # Install Python modules
      - install -Dm644 gentle-rgb-clear.py ${FLATPAK_DEST}/lib/python3/site-packages/originpc_rgb/gentle_rgb_clear.py
      - install -Dm644 lid-monitor-daemon.py ${FLATPAK_DEST}/lib/python3/site-packages/originpc_rgb/lid_monitor_daemon.py
      - install -Dm644 originpc-rgb-fix.py ${FLATPAK_DEST}/lib/python3/site-packages/originpc_rgb/rgb_fix.py
      - touch ${FLATPAK_DEST}/lib/python3/site-packages/originpc_rgb/__init__.py
      
      # Install desktop file
      - install -Dm644 originpc-control-center.desktop ${FLATPAK_DEST}/share/applications/org.originpc.ControlCenter.desktop
      
      # Update desktop file for Flatpak
      - sed -i 's/Exec=originpc-control-center/Exec=originpc-control-center/' ${FLATPAK_DEST}/share/applications/org.originpc.ControlCenter.desktop
      # Keep the original icon name since we don't have a custom icon
      - sed -i 's/Icon=.*/Icon=preferences-desktop-peripherals/' ${FLATPAK_DEST}/share/applications/org.originpc.ControlCenter.desktop
      
    sources:
      - type: dir
        path: ../src
      - type: file
        path: ../originpc-control-center.desktop
